---
const {
  src = "",
  ariaLabel = "Audio player",
  filename,
  poster,
} = Astro.props as {
  src?: string;
  ariaLabel?: string;
  filename?: string;
  poster?: string;
};

let audioSrc: string = src;
if (!/^https?:\/\//i.test(src) && !src.startsWith("/")) {
  try {
    audioSrc = new URL(`../assets/audio-lessons/${src}`, import.meta.url).href;
  } catch (e) {
    audioSrc = src;
  }
}
const uid = `ap-${Math.random().toString(36).slice(2, 9)}`;
---

<div
  class="audio-player"
  data-audio-filename={filename || ""}
  data-audio-poster={poster || ""}
>
  <audio
    id={`audio-${uid}`}
    controls
    src={audioSrc}
    aria-label={ariaLabel}
    preload="metadata"
    style="width:100%;max-width:560px;"
  >
    <source src={audioSrc} type="audio/mp4" />
    Your browser does not support the audio element.
  </audio>

  <script type="module">
    (function () {
      try {
        const script = document.currentScript;
        const container =
          script && script.closest && script.closest(".audio-player");
        if (!container) return;
        const audio = container.querySelector("audio");
        if (!audio) return;

        const title =
          container.dataset.audioFilename || document.title || "Audio";
        const poster = container.dataset.audioPoster || "";

        let mediaSessionReady = false;
        let initializing = false;
        let keepAliveTimer = null;
        let wakeLockSentinel = null;
        let lastPositionUpdate = 0;

        // ---------- Wake Lock ----------
        async function requestWakeLock() {
          try {
            if ("wakeLock" in navigator && !wakeLockSentinel) {
              wakeLockSentinel = await navigator.wakeLock.request("screen");
              wakeLockSentinel.addEventListener("release", () => {
                wakeLockSentinel = null;
              });
            }
          } catch (err) {
            console.warn(
              "[AudioPlayer] Wake Lock non disponibile:",
              err?.message || err
            );
          }
        }
        async function releaseWakeLock() {
          if (!wakeLockSentinel) return;
          try {
            await wakeLockSentinel.release();
          } catch (err) {
            console.warn(
              "[AudioPlayer] Errore rilascio Wake Lock:",
              err?.message || err
            );
          } finally {
            wakeLockSentinel = null;
          }
        }

        // ---------- Media Session ----------
        function resetPositionState() {
          try {
            if (
              "mediaSession" in navigator &&
              navigator.mediaSession.setPositionState
            ) {
              navigator.mediaSession.setPositionState(null);
            }
          } catch {}
        }

        function updatePositionState(force = false) {
          if (!("mediaSession" in navigator)) return;
          if (!navigator.mediaSession.setPositionState) return;
          if (!mediaSessionReady) return;

          const duration = audio.duration;
          const currentTime = audio.currentTime;
          const rate = audio.playbackRate || 1;

          if (!isFinite(duration) || duration <= 0) return;
          if (!isFinite(currentTime) || currentTime < 0) return;
          if (!isFinite(rate) || rate <= 0) return;

          const now = Date.now();
          if (!force && now - lastPositionUpdate < 500) return;
          lastPositionUpdate = now;

          try {
            navigator.mediaSession.setPositionState({
              duration,
              playbackRate: rate,
              position: Math.max(0, Math.min(currentTime, duration)),
            });
          } catch (e) {
            console.warn(
              "[AudioPlayer] Position update error:",
              e?.message || e
            );
          }
        }

        function setupMediaSession() {
          if (!("mediaSession" in navigator)) return;
          if (mediaSessionReady || initializing) return;
          initializing = true;

          try {
            const artworkUrl =
              poster ||
              "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23667' width='100' height='100'/%3E%3Cpath fill='%23fff' d='M35 25l40 25-40 25z'/%3E%3C/svg%3E";

            navigator.mediaSession.metadata = new MediaMetadata({
              title: title || "Audio Lesson",
              artist: "Podcast",
              album: "Learning",
              artwork: [
                { src: artworkUrl, sizes: "96x96", type: "image/png" },
                { src: artworkUrl, sizes: "128x128", type: "image/png" },
                { src: artworkUrl, sizes: "192x192", type: "image/png" },
                { src: artworkUrl, sizes: "256x256", type: "image/png" },
                { src: artworkUrl, sizes: "384x384", type: "image/png" },
                { src: artworkUrl, sizes: "512x512", type: "image/png" },
              ],
            });

            navigator.mediaSession.setActionHandler("play", () => {
              audio.play().catch((err) => {
                console.warn(
                  "[AudioPlayer] Play rejected:",
                  err?.message || err
                );
              });
            });
            navigator.mediaSession.setActionHandler("pause", () =>
              audio.pause()
            );
            navigator.mediaSession.setActionHandler("seekbackward", (d) => {
              const s = (d && d.seekOffset) || 10;
              audio.currentTime = Math.max(0, audio.currentTime - s);
              updatePositionState(true);
            });
            navigator.mediaSession.setActionHandler("seekforward", (d) => {
              const s = (d && d.seekOffset) || 10;
              audio.currentTime = Math.min(
                audio.duration || Infinity,
                audio.currentTime + s
              );
              updatePositionState(true);
            });
            navigator.mediaSession.setActionHandler("seekto", (d) => {
              if (d && typeof d.seekTime === "number") {
                const t = Math.max(
                  0,
                  Math.min(d.seekTime, audio.duration || 0)
                );
                audio.currentTime = t;
                updatePositionState(true);
                setTimeout(() => updatePositionState(true), 60);
                setTimeout(() => updatePositionState(true), 180);
              }
            });
            navigator.mediaSession.setActionHandler("stop", () => {
              audio.pause();
              audio.currentTime = 0;
              updatePositionState(true);
            });
            try {
              navigator.mediaSession.setActionHandler("previoustrack", null);
              navigator.mediaSession.setActionHandler("nexttrack", null);
            } catch {}

            mediaSessionReady = true;
          } catch (e) {
            console.warn(
              "[AudioPlayer] Media Session setup error:",
              e?.message || e
            );
          } finally {
            initializing = false;
          }
        }

        // ---------- Keep-alive (uno solo) ----------
        function startKeepAlive() {
          if (keepAliveTimer) return;
          keepAliveTimer = setInterval(() => {
            if (
              !audio.paused &&
              isFinite(audio.duration) &&
              audio.duration > 0
            ) {
              // piccolo “ping” per mantenere attiva la notifica/slider
              try {
                if ("mediaSession" in navigator) {
                  navigator.mediaSession.playbackState = "playing";
                }
              } catch {}
              updatePositionState(true);
            }
          }, 8000);
        }
        function stopKeepAlive() {
          if (keepAliveTimer) {
            clearInterval(keepAliveTimer);
            keepAliveTimer = null;
          }
        }

        // ---------- Eventi ----------
        audio.addEventListener("loadedmetadata", () => {
          setupMediaSession();
          resetPositionState(); // evita slider a fine barra
          setTimeout(() => updatePositionState(true), 120);
        });

        audio.addEventListener("play", () => {
          setupMediaSession();
          try {
            if ("mediaSession" in navigator) {
              navigator.mediaSession.playbackState = "playing";
            }
          } catch {}
          requestWakeLock();
          startKeepAlive();
          setTimeout(() => updatePositionState(true), 100);
        });

        audio.addEventListener("pause", () => {
          try {
            if ("mediaSession" in navigator) {
              navigator.mediaSession.playbackState = "paused";
            }
          } catch {}
          stopKeepAlive();
          releaseWakeLock();
          updatePositionState(true);
        });

        audio.addEventListener("ended", () => {
          try {
            if ("mediaSession" in navigator) {
              navigator.mediaSession.playbackState = "none";
            }
          } catch {}
          stopKeepAlive();
          releaseWakeLock();
          resetPositionState();
        });

        // Aggiornamenti regolari ma “throttled”
        audio.addEventListener("timeupdate", () => {
          if (!audio.paused && audio.readyState >= 2) {
            updatePositionState(); // non forzato, rispetta throttling 500ms
          }
        });

        audio.addEventListener("seeked", () => {
          updatePositionState(true);
          setTimeout(() => updatePositionState(true), 100);
          setTimeout(() => updatePositionState(true), 300);
        });

        audio.addEventListener("ratechange", () => {
          updatePositionState(true);
        });

        audio.addEventListener("durationchange", () => {
          if (isFinite(audio.duration) && audio.duration > 0) {
            setupMediaSession();
            setTimeout(() => updatePositionState(true), 100);
          }
        });

        audio.addEventListener("error", (e) => {
          console.error("[AudioPlayer] Audio error:", e);
          try {
            if ("mediaSession" in navigator) {
              navigator.mediaSession.playbackState = "none";
            }
          } catch {}
          stopKeepAlive();
          releaseWakeLock();
          mediaSessionReady = false;
        });

        // Visibilità pagina
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible" && !audio.paused) {
            requestWakeLock();
            updatePositionState(true);
          }
        });

        // Init rapido se metadata già pronti
        if (audio.readyState >= 2) {
          setupMediaSession();
          resetPositionState();
          setTimeout(() => updatePositionState(true), 120);
        }

        // Cleanup
        const cleanup = () => {
          stopKeepAlive();
          releaseWakeLock();
        };
        window.addEventListener("beforeunload", cleanup);
        window.addEventListener("unload", cleanup);
      } catch (e) {
        console.error("[AudioPlayer] Component error:", e);
      }
    })();
  </script>
</div>

<style>
  .audio-player {
    margin: 0.75rem 0 1.25rem 0;
  }
</style>
